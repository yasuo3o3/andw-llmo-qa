# andW llmo-qa

WordPressの `/qa/` 配下で「質問＋即答＋解説」構造のQ&Aサイトを構築するプラグインです。FAQ構造化データ（JSON-LD）の自動出力、カスタム投稿タイプ、カテゴリ・タグによる分類、CSV一括投入、3つのGutenbergブロック、ショートコード、関連リンク自動挿入機能を提供します。

## 主な機能

- **CPT「qa」**: 質問・即答・詳細解説の構造化されたQ&A投稿
- **二軸分類**: 階層カテゴリ（`qa_category`）+ 横断タグ（`qa_tag`）
- **3つの専用ブロック**: 即答入力、一覧表示、インデックス表示
- **CSV一括投入**: SJIS/UTF-8対応、ドライラン機能付き
- **JSON-LD自動出力**: FAQPage構造化データでSEO対応
- **管理UI**: 標準タグボックス＋チェックボックス式タグ選択
- **関連リンク自動挿入**: 同カテゴリ記事の自動表示
- **タグ機能**: チップ表示・本文内ハイライト（設定で制御）
- **テンプレートシステム**: テーマでのカスタマイズ対応

## 動作要件

- WordPress 5.0以上
- PHP 7.4以上
- Gutenbergエディタ有効

## インストール

### ZIPファイルからのインストール

1. このリポジトリをZIPでダウンロード
2. WordPress管理画面 > プラグイン > 新規追加 > プラグインのアップロード
3. ZIPファイルを選択してインストール
4. プラグインを有効化

### Gitクローンでのインストール

```bash
cd /path/to/wordpress/wp-content/plugins/
git clone [repository-url] andw-qa
```

WordPress管理画面でプラグインを有効化してください。

## クイックスタート

1. **プラグインを有効化** → 管理画面に「Q&A」メニューが追加
2. **Q&A > 新規追加**で質問・即答・解説を入力
3. **カテゴリ・タグを設定**して分類
4. **フロントエンド確認**: `/qa/` で一覧、`/qa/投稿スラッグ/` で単体表示
5. **ブロック挿入**: エディタで「Q&A一覧」「Q&Aインデックス」ブロックを配置

## コンテンツ構造

### カスタム投稿タイプ: `qa`

- **パーマリンク**: `/qa/%投稿名%/`
- **アーカイブ**: `/qa/`
- **サポート**: タイトル、エディタ、作成者、アイキャッチ、リビジョン
- **カスタムフィールド**: `_andwqa_short_answer`（即答テキスト）

### タクソノミー

#### `qa_category`（階層カテゴリ）
- **URL**: `/qa/カテゴリスラッグ/`
- **階層**: 親子関係対応
- **用途**: メインの分類軸

#### `qa_tag`（非階層タグ）
- **URL**: `/qa-tag/タグスラッグ/`
- **階層**: 無し（WordPress標準タグと同じ）
- **用途**: 横断的なキーワード分類

## ブロック一覧

### `andw/llmo-short-answer`（即答（LLMO））
- **用途**: 即答テキストの入力・編集
- **機能**: カスタムフィールドとの双方向バインド
- **属性**: なし（メタフィールドから自動取得）

### `andw/llmo-qa-list`（Q&A一覧（カテゴリ））
- **用途**: 指定条件での一覧表示
- **主な属性**:
  - `category`: カテゴリスラッグ（カンマ区切り可）
  - `tags`: タグスラッグ（カンマ区切り可）
  - `limit`: 表示件数（1-48、デフォルト12）
  - `columns`: 列数（1-6、デフォルト2）
  - `showShort`: 即答表示（デフォルト：true）
  - `showTitle`: タイトル表示（デフォルト：true）

### `andw/llmo-qa-index`（Q&Aインデックス（複数カテゴリ））
- **用途**: 複数カテゴリのセクション表示
- **主な属性**:
  - `categories`: カテゴリスラッグ（カンマ区切り必須）
  - `tags`: タグスラッグ（カンマ区切り、カテゴリとAND条件）
  - `perCategory`: カテゴリごとの件数（1-24、デフォルト6）
  - `columns`: 列数（1-6、デフォルト2）
  - `showShort`: 即答表示（デフォルト：true）
  - `showMoreLink`: 「もっと見る」リンク（デフォルト：true）

## ショートコード

### `[andw_llmo_qa_list]` - 一覧表示

**基本的な使用例**:
```
[andw_llmo_qa_list limit="10"]
[andw_llmo_qa_list category="reform,mongolia" limit="20"]
[andw_llmo_qa_list tags="初心者,費用" limit="15"]
[andw_llmo_qa_list category="reform" tags="費用" limit="8"]
```

**利用可能な属性**:
- `category`: カテゴリスラッグ（カンマ区切り可）
- `tags`: タグスラッグ（カンマ区切り可）
- `limit`: 表示件数（デフォルト：20）

※ `category`と`tags`を同時指定した場合はAND条件で絞り込まれます。

### `[andw_llmo_qa]` - 単体表示

```
[andw_llmo_qa id="123"]
```

**属性**:
- `id`: 投稿ID（必須）

## CSVインポート

### 使い方

1. **Q&A > CSVインポート & 設定**へアクセス
2. CSVファイルを選択（UTF-8推奨、SJIS自動変換対応）
3. **「ドライラン」チェック**で事前検証（推奨）
4. 問題なければドライランを外して本実行

### カラム仕様

| カラム名 | 必須 | 説明 |
|----------|------|------|
| `title` | ✓ | 質問文（投稿タイトル） |
| `short_answer` | ✓ | 即答（50〜100文字推奨） |
| `content` | ✓ | 解説（HTML可） |
| `categories` | | カテゴリスラッグをカンマ区切り |
| `tags` | | タグ名をカンマ区切り |
| `slug` | | 投稿スラッグ |
| `status` | | publish / draft（デフォルト：publish） |

### サンプルCSV

```csv
title,short_answer,content,categories,tags,slug,status
"モンゴル乗馬は初心者でも参加できる？","初心者歓迎ツアーが多く、初日に基本レクチャーを受けてから草原へ出ます。","<p>多くのツアーで安全指導と基礎練習を用意…</p>","mongolia","初心者,安全,乗馬","beginner-ok","publish"
"キッチンリフォームの費用相場はいくら？","規模により20〜150万円程度。間取り変更や設備グレードで変動します。","<p>…</p>","reform","費用,相場,キッチン","kitchen-cost","draft"
```

## 設定項目（管理画面）

**Q&A > CSVインポート & 設定**で以下を設定可能:

### 関連リンク自動挿入
- **有効化**: 記事本文末尾に「関連Q&A」を自動表示
- **件数**: 表示する関連記事数（1-20件、デフォルト：6件）
- **条件**: 同一カテゴリの最新記事を表示

### タグ機能設定
- **タグチップ表示**: 単体記事のタイトル下にタグをリンク表示（デフォルト：ON）
- **タグ語ハイライト**: 本文中のタグ語を `<mark class="tagged">` でマーク（デフォルト：OFF）
  - HTMLを壊さない安全な実装
  - `<code>`、`<pre>`、`<a>` タグ内は除外

## JSON-LD（FAQPage）出力仕様

### 単一記事ページ

```json
{
  "@context": "https://schema.org",
  "@type": "FAQPage",
  "mainEntity": [{
    "@type": "Question",
    "name": "質問タイトル",
    "acceptedAnswer": {
      "@type": "Answer",
      "text": "即答テキスト"
    }
  }]
}
```

**出力条件**: 
- `single-qa.php`での表示時
- 即答（`_andwqa_short_answer`）が設定されている場合のみ

### アーカイブページ

- **出力対象**: `/qa/`（投稿タイプアーカイブ）、`/qa/カテゴリ/`（カテゴリアーカイブ）
- **出力制限**: 最大10件、即答が設定されている投稿のみ
- **除外**: `/qa-tag/xxx/`（タグアーカイブ）には出力されません

## テンプレート

### `templates/single-qa.php`
単体Q&A記事の表示テンプレート。タグチップ表示機能を含む。

### `templates/archive-qa.php`  
Q&A一覧・カテゴリアーカイブの表示テンプレート。

### `templates/taxonomy-qa_tag.php`
タグアーカイブの表示テンプレート。

**テーマでのオーバーライド**:
テーマディレクトリに同名ファイルを配置すると、そちらが優先されます。

## フォルダ構成

```
andw-qa/
├── andw-qa.php              # メインプラグインファイル
├── README.md
├── LICENSE
├── admin/
│   └── import-page.php      # CSV設定画面
├── assets/
│   ├── admin.css           # 管理画面CSS
│   └── style.css           # フロントエンドCSS
├── blocks/
│   ├── short-answer/       # 即答ブロック
│   │   ├── block.json
│   │   ├── index.js
│   │   └── index.php
│   ├── qa-list/           # 一覧ブロック
│   │   ├── block.json
│   │   ├── index.js
│   │   └── index.php
│   └── qa-index/          # インデックスブロック
│       ├── block.json
│       ├── index.js
│       └── index.php
└── templates/
    ├── single-qa.php       # 単体表示テンプレート
    ├── archive-qa.php      # 一覧表示テンプレート
    └── taxonomy-qa_tag.php # タグアーカイブテンプレート
```

## 開発

### ビルド不要のブロック設計
JavaScriptブロックは `window.wp` オブジェクトを使用する軽量設計で、ビルドプロセスを必要としません。

### コーディング規約
- WordPress Coding Standards準拠
- セキュリティ: `esc_html()`, `wp_kses_post()`, `wp_verify_nonce()`等を適切に使用
- 国際化: Text Domain `andw-qa` でi18n対応

### 推奨ワークフロー

1. **開発環境**: Local by FlywhheelまたはDockerでWordPress環境構築
2. **テスト**: 各ブロック・ショートコード・CSV機能の動作確認
3. **カスタマイズ**: `templates/`ファイルやCSSオーバーライドで見た目調整

## 変更履歴

### v0.03 (2024-08)
- **横断タグ機能追加**: `qa_tag`タクソノミー実装
- **チェックボックス型タグUI**: 管理画面での直感的なタグ選択
- **CSV インポート**: tagsカラム対応
- **ブロック拡張**: qa-list・qa-indexでタグ絞り込み対応
- **タグアーカイブ**: 専用テンプレート追加
- **タグチップ表示**: 単体記事での視覚的タグ表示
- **ハイライト機能**: 本文中のタグ語を安全にマーク

### v0.02
- CPT・タクソノミー基本構造
- 3つの専用Gutenbergブロック
- CSVインポート機能
- JSON-LD構造化データ出力
- 関連リンク自動挿入

## ライセンス

GPLv2 or later

## サポート・バグ報告
製作者: Netservice (https://netservice.jp/)

---

> 本プラグインはAIの学習効率を高める「即答＋詳細解説」構造と、検索エンジン最適化を両立したFAQ構築を目的として開発されています。
